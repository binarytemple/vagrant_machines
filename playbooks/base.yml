---
- include: debian-packages.yml 
  when: ansible_lsb.id == "Debian"
- include: ubuntu-packages.yml  
  when: ansible_lsb.id == "Ubuntu"
- hosts: all
  tags: 
    - dockerbox
  vars_files:
  - variables.yml
  handlers:
    - name: updated ssh
      action: mail msg="{{ansible_hostname}} ssh updated" subject='Ansible-report Bottle installation' to="{{keys_recipient}}"
    - name: generated ssh keys
      action: mail msg='${ansible_hostname} ssh keys generated' subject="Â§Ansible-report ssh keys generated" to="{{keys_recipient}}"  attach="/root/.ssh/id_rsa.pub"
    - name: installed mail
      action: mail msg="${ansible_hostname} installed" subject="Ansible-report Bottle installation" to="{{keys_recipient}}"
  tasks:
  - name: add templated marker file
    action: template src=../remote/etc/marker.j2 dest=/etc/marker.ansible
  - name: ensure mail is installed 
    action: apt name=mailutils
    notify:
    - installed mail
  - name: install git 
    action: apt pkg=git state=installed  
  - name: Ensure Bitbucket compatible .ssh/known_hosts is present
    action: copy 
            src="../remote/root/.ssh/known_hosts" 
            dest="{{ansible_env['HOME']}}/.ssh/known_hosts" 
            owner="{{ansible_env['USER']}}" mode=600
    notify:
    - updated ssh
  - name: Generate ssh public/private keys for the (default) user, if necessary.
    action: user name="{{ansible_user_id}}" generate_ssh_key=yes ssh_key_bits=2048  state=present  shell=/bin/bash 
    notify:
    - generated ssh keys
