---
- include: base.yml
- hosts: all
  roles:
        - binarytemple.docker
  user: vagrant
  sudo: yes
  handlers:
  - name: updated ssh
    action: mail msg='{{ansible_hostname}} ssh updated' 
                 subject='ssh updated' 
                 to="{{keys_recipient}}"

  - name: generated ssh keys
    action: mail 
            msg='${ansible_hostname} ssh keys generated' 
            subject="Ansible-report ssh keys generated" 
            to="{{keys_recipient}}" 
            attach="/home/ansible/.ssh/id_rsa.pub"

  - name: slurp the generated ssh_key 
    action: slurp 
      src="/home/ansible/.ssh/id_rsa.pub"
    register: ssh_content

  - name: output the generated ssh_key
    action: debug msg="Contents of ssh public key {{ssh_content}}"

  tasks:
   
   - name: get value of current user
     action: debug msg="Value of ansible_env['HOME'] is {{ansible_env['HOME']}}"
  
   - name: get home of current user 
     action: debug msg="Value of ansible_env['USER'] is {{ansible_env['USER']}}"

   - name: Generate ssh public/private keys for the (default) user, if necessary.
     action: user 
        name="vagrant" 
        generate_ssh_key=yes 
        ssh_key_bits=2048  
        state=present  
        shell=/bin/bash 
     notify:
     - generated ssh keys

   - name: Ensure Bitbucket compatible .ssh/known_hosts is present
     action: copy 
            src="../remote/root/.ssh/known_hosts" 
            dest="/home/vagrant/.ssh/known_hosts" 
            owner="vagrant" mode=600
            force="no"
     notify:
     - updated ssh

   - name: output user name
     action: debug msg = "user is {{ansible_env['USER']}}"

   - name: copy docker project to filesystem location
     action: git 
        repo="git@bitbucket.org:bryan_picsolve/poc_docker.git"
        dest = "vagrant/poc_docker" 
        version = master